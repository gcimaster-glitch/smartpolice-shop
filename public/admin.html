<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†ç”»é¢ | ã‚¹ãƒãƒ¼ãƒˆãƒãƒªã‚¹</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .admin-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .admin-tabs { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #e0e0e0; }
    .admin-tab { padding: 1rem 2rem; cursor: pointer; border: none; background: none; font-size: 1rem; font-weight: 600; color: var(--text-light); }
    .admin-tab.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); margin-bottom: -2px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .ai-form { background: #f8f9fa; padding: 2rem; border-radius: 10px; margin-bottom: 2rem; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem; }
    .preview-card { background: white; padding: 2rem; border-radius: 10px; border: 2px solid #e0e0e0; }
    .preview-images { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .preview-image { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .loading-content { background: white; padding: 3rem; border-radius: 10px; text-align: center; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="/" class="logo">ğŸ›¡ï¸ ã‚¹ãƒãƒ¼ãƒˆãƒãƒªã‚¹ ç®¡ç†ç”»é¢</a>
      <button onclick="logout()" class="btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </nav>
  </header>

  <div id="login-form" style="max-width: 400px; margin: 4rem auto;">
    <div class="card">
      <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="form-group">
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
      </div>
      <div class="form-group">
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      </div>
      <button onclick="login()" class="btn btn-primary" style="width: 100%;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
  </div>

  <div id="admin-panel" style="display: none;">
    <div class="admin-container">
      <h1>ç®¡ç†ç”»é¢</h1>

      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchTab('manual-register')">âœï¸ æ‰‹å‹•å•†å“ç™»éŒ²</button>
        <button class="admin-tab" onclick="switchTab('products')">ğŸ“¦ å•†å“ç®¡ç†</button>
        <button class="admin-tab" onclick="switchTab('orders')">ğŸ“‹ æ³¨æ–‡ç®¡ç†</button>
      </div>

      <!-- æ‰‹å‹•å•†å“ç™»éŒ²ã‚¿ãƒ– -->
      <div id="manual-register-tab" class="tab-content active">
        <div class="ai-form">
          <h2>âœï¸ æ‰‹å‹•å•†å“ç™»éŒ²</h2>
          <p style="color: var(--text-light); margin-bottom: 2rem;">å•†å“æƒ…å ±ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚æ­£ç¢ºã§ç¢ºå®Ÿãªæ–¹æ³•ã§ã™ã€‚</p>

          <div class="form-group">
            <label>å•†å“åï¼ˆæ—¥æœ¬èªï¼‰ *</label>
            <input type="text" id="manual-name" placeholder="ä¾‹: é«˜æ€§èƒ½ GPSè¿½è·¡ãƒ‡ãƒã‚¤ã‚¹" required>
          </div>

          <div class="form-group">
            <label>å•†å“èª¬æ˜ï¼ˆæ—¥æœ¬èªï¼‰ *</label>
            <textarea id="manual-description" rows="6" placeholder="å•†å“ã®ç‰¹å¾´ã€ç”¨é€”ã€ãƒ¡ãƒªãƒƒãƒˆãªã©ã‚’è©³ã—ãè¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚&#10;&#10;ä¾‹ï¼š&#10;ãƒ»24æ™‚é–“365æ—¥ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡&#10;ãƒ»ãƒãƒƒãƒ†ãƒªãƒ¼æŒç¶šæ™‚é–“æœ€å¤§30æ—¥&#10;ãƒ»é˜²æ°´ä»•æ§˜ï¼ˆIP67ï¼‰&#10;ãƒ»ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªã§ç°¡å˜ç®¡ç†" required></textarea>
          </div>

          <div class="form-group">
            <label>è²©å£²ä¾¡æ ¼ï¼ˆå††ï¼‰ *</label>
            <input type="number" id="manual-price" placeholder="ä¾‹: 12800" min="0" required>
          </div>

          <div class="form-group">
            <label>ã‚«ãƒ†ã‚´ãƒª *</label>
            <select id="manual-category" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="å€‹äººå‘ã‘">å€‹äººå‘ã‘</option>
              <option value="ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ ">ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ </option>
              <option value="è»Šä¸¡ãƒ»ãƒã‚¤ã‚¯">è»Šä¸¡ãƒ»ãƒã‚¤ã‚¯</option>
            </select>
          </div>

          <div class="form-group">
            <label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input type="text" id="manual-tags" placeholder="ä¾‹: GPS, è¿½è·¡, é˜²çŠ¯, è»Šä¸¡">
            <small style="color: var(--text-light);">æ¤œç´¢ã‚„ãƒ•ã‚£ãƒ«ã‚¿ã«ä½¿ç”¨ã•ã‚Œã¾ã™</small>
          </div>

          <div class="form-group">
            <label>å•†å“ç”»åƒURLï¼ˆ1è¡Œã«1ã¤ã€è¤‡æ•°å¯ï¼‰</label>
            <textarea id="manual-images" rows="4" placeholder="ä¾‹:&#10;https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
            <small style="color: var(--text-light);">Alibabaã®ç”»åƒURLã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„</small>
          </div>

          <div class="form-group">
            <label>åœ¨åº«çŠ¶æ³ *</label>
            <select id="manual-stock" required>
              <option value="in_stock">åœ¨åº«ã‚ã‚Š</option>
              <option value="out_of_stock">åœ¨åº«åˆ‡ã‚Œ</option>
              <option value="discontinued">å–æ‰±çµ‚äº†</option>
            </select>
          </div>

          <div class="form-group">
            <label>Alibabaå•†å“URLï¼ˆè¨˜éŒ²ç”¨ï¼‰</label>
            <input type="url" id="manual-alibaba-url" placeholder="https://www.alibaba.com/product-detail/...">
            <small style="color: var(--text-light);">ä»•å…¥ã‚Œå…ƒã®è¨˜éŒ²ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™</small>
          </div>

          <div class="form-group">
            <label>ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆãƒ‰ãƒ«/è¨˜éŒ²ç”¨ï¼‰</label>
            <input type="number" id="manual-alibaba-price" placeholder="ä¾‹: 10.50" min="0" step="0.01">
            <small style="color: var(--text-light);">åˆ©ç›Šç®¡ç†ã®ãŸã‚è¨˜éŒ²ã—ã¦ãŠãã“ã¨ã‚’æ¨å¥¨</small>
          </div>

          <div class="form-group">
            <label>è£½å“ä»•æ§˜ï¼ˆJSONå½¢å¼ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
            <textarea id="manual-specs" rows="6" placeholder='ä¾‹:&#10;{&#10;  "ã‚µã‚¤ã‚º": "60Ã—40Ã—20mm",&#10;  "é‡é‡": "50g",&#10;  "ãƒãƒƒãƒ†ãƒªãƒ¼": "30æ—¥é–“",&#10;  "é˜²æ°´": "IP67"&#10;}'></textarea>
            <small style="color: var(--text-light);">JSONå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå…¥åŠ›ãªã—ã§ã‚‚OKï¼‰</small>
          </div>

          <button onclick="registerManualProduct()" class="btn btn-primary" style="width: 100%; padding: 1.25rem; font-size: 1.25rem; font-weight: 700;">
            âœ… å•†å“ã‚’ç™»éŒ²ã™ã‚‹
          </button>
        </div>
      </div>

      <!-- AIå•†å“ç™»éŒ²ã‚¿ãƒ–ï¼ˆéæ¨å¥¨ï¼‰ -->
      <div id="ai-register-tab" class="tab-content" style="display: none;">
        <div class="ai-form" style="opacity: 0.6;">
          <h2>ğŸ¤– AIå•†å“ç™»éŒ²ï¼ˆéæ¨å¥¨ï¼‰</h2>
          <p style="color: #d32f2f; margin-bottom: 1rem; font-weight: 600;">
            âš ï¸ ã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã›ã‚“ã€‚æ‰‹å‹•å•†å“ç™»éŒ²ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
          </p>
        </div>
      </div>
        <div class="ai-form">
          <h2>ğŸ¤– AIå•†å“ç™»éŒ²</h2>
          <p style="color: var(--text-light); margin-bottom: 2rem;">Alibabaã®å•†å“URLã‚’å…¥åŠ›ã™ã‚‹ã¨ã€AIãŒè‡ªå‹•ã§å•†å“æƒ…å ±ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚</p>

          <div class="form-group">
            <label>Alibabaå•†å“URL *</label>
            <input type="url" id="alibaba-url" placeholder="https://www.alibaba.com/product-detail/..." 
                   value="https://www.alibaba.com/product-detail/10-Hours-Work-Anti-spy-Bug_1601658778634.html">
          </div>

          <div class="form-group">
            <label>ãƒãƒ¼ã‚¸ãƒ³ç‡ï¼ˆ%ï¼‰ *</label>
            <input type="number" id="margin-rate" value="100" min="0" max="500" placeholder="100">
            <small style="color: var(--text-light);">ä¾‹: 100% = ä»•å…¥ã‚Œä¾¡æ ¼ã®2å€ã§è²©å£²</small>
          </div>

          <button onclick="analyzeProduct()" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.125rem;">
            ğŸ” AIåˆ†æã‚’é–‹å§‹
          </button>
        </div>

        <div id="preview-section" style="display: none;">
          <div class="preview-card">
            <h2>ğŸ“ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <div id="preview-content"></div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
              <button onclick="registerProduct()" class="btn btn-primary" style="flex: 1; padding: 1rem;">âœ… ã“ã®å†…å®¹ã§ç™»éŒ²</button>
              <button onclick="cancelPreview()" class="btn" style="flex: 1; padding: 1rem;">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
        </div>
      </div>

      <!-- å•†å“ç®¡ç†ã‚¿ãƒ– -->
      <div id="products-tab" class="tab-content">
        <h2>å•†å“ç®¡ç†</h2>
        <p>é–‹ç™ºä¸­...</p>
      </div>

      <!-- æ³¨æ–‡ç®¡ç†ã‚¿ãƒ– -->
      <div id="orders-tab" class="tab-content">
        <h2>æ³¨æ–‡ç®¡ç†</h2>
        <p>é–‹ç™ºä¸­...</p>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <div class="spinner" style="width: 60px; height: 60px; margin: 0 auto 1.5rem;"></div>
      <h3>AIåˆ†æä¸­...</h3>
      <p style="color: var(--text-light);">å•†å“æƒ…å ±ã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™ï¼ˆ30ç§’ç¨‹åº¦ï¼‰</p>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    let adminToken = null;
    let analyzedProduct = null;

    // AdminNotification ã‚¯ãƒ©ã‚¹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶çµ„ã¿è¾¼ã¿ã®Notificationã¨ã®ç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
    class AdminNotification {
      static success(message) {
        this.show(message, 'success');
      }
      
      static error(message) {
        this.show(message, 'error');
      }
      
      static show(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 1rem 1.5rem;
          background: ${type === 'success' ? '#4caf50' : '#f44336'};
          color: white;
          border-radius: 5px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          animation: slideIn 0.3s ease-out;
          max-width: 400px;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        AdminNotification.error('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        if (!text) {
          throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸ');
        }
        
        const data = JSON.parse(text);
        
        if (data.success) {
          adminToken = data.data.token;
          localStorage.setItem('admin_token', adminToken);
          document.getElementById('login-form').style.display = 'none';
          document.getElementById('admin-panel').style.display = 'block';
          AdminNotification.success('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
        } else {
          AdminNotification.error(data.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('Login error:', error);
        AdminNotification.error('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    function logout() {
      localStorage.removeItem('admin_token');
      location.reload();
    }

    function switchTab(tabName) {
      document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    // æ‰‹å‹•å•†å“ç™»éŒ²é–¢æ•°
    async function registerManualProduct() {
      // å…¥åŠ›å€¤ã‚’å–å¾—
      const name = document.getElementById('manual-name').value.trim();
      const description = document.getElementById('manual-description').value.trim();
      const price = parseFloat(document.getElementById('manual-price').value);
      const category = document.getElementById('manual-category').value;
      const tagsInput = document.getElementById('manual-tags').value.trim();
      const imagesInput = document.getElementById('manual-images').value.trim();
      const stockStatus = document.getElementById('manual-stock').value;
      const alibabaUrl = document.getElementById('manual-alibaba-url').value.trim();
      const alibabaPrice = document.getElementById('manual-alibaba-price').value;
      const specsInput = document.getElementById('manual-specs').value.trim();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!name) {
        AdminNotification.error('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (!description) {
        AdminNotification.error('å•†å“èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (!price || price <= 0) {
        AdminNotification.error('æœ‰åŠ¹ãªè²©å£²ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (!category) {
        AdminNotification.error('ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // ã‚¿ã‚°ã‚’é…åˆ—ã«å¤‰æ›
      const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

      // ç”»åƒURLã‚’é…åˆ—ã«å¤‰æ›
      const imageUrls = imagesInput ? imagesInput.split('\n').map(url => url.trim()).filter(url => url) : [];

      // ä»•æ§˜ã‚’JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
      let specifications = {};
      if (specsInput) {
        try {
          specifications = JSON.parse(specsInput);
        } catch (e) {
          AdminNotification.error('è£½å“ä»•æ§˜ã®JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
          return;
        }
      }

      // å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
      const productData = {
        name,
        description,
        price,
        category,
        stock_status: stockStatus,
        image_urls: imageUrls,
        specifications,
        alibaba_url: alibabaUrl || null,
        alibaba_price: alibabaPrice ? parseFloat(alibabaPrice) : null
      };

      // ç™»éŒ²å®Ÿè¡Œ
      try {
        const response = await fetch('/api/admin/products', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify(productData)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const text = await response.text();
        if (!text) {
          throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸ');
        }

        const data = JSON.parse(text);

        if (data.success) {
          AdminNotification.success('å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
          document.getElementById('manual-name').value = '';
          document.getElementById('manual-description').value = '';
          document.getElementById('manual-price').value = '';
          document.getElementById('manual-category').value = '';
          document.getElementById('manual-tags').value = '';
          document.getElementById('manual-images').value = '';
          document.getElementById('manual-stock').value = 'in_stock';
          document.getElementById('manual-alibaba-url').value = '';
          document.getElementById('manual-alibaba-price').value = '';
          document.getElementById('manual-specs').value = '';
          
          // 3ç§’å¾Œã«å•†å“ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’é–‹ã
          setTimeout(() => {
            window.open('/products.html', '_blank');
          }, 1500);
        } else {
          throw new Error(data.error || 'å•†å“ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('Register error:', error);
        AdminNotification.error('å•†å“ç™»éŒ²ã«å¤±æ•—: ' + error.message);
      }
    }

    async function analyzeProduct() {
      const alibabaUrl = document.getElementById('alibaba-url').value;
      const marginRate = parseInt(document.getElementById('margin-rate').value);

      if (!alibabaUrl) {
        AdminNotification.error('Alibaba URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      document.getElementById('loading-overlay').style.display = 'flex';

      try {
        const response = await fetch('/api/admin/alibaba/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ 
            alibaba_url: alibabaUrl, 
            profit_margin: marginRate 
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        analyzedProduct = data.data.product;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        document.getElementById('preview-content').innerHTML = `
          <div class="form-group">
            <label>å•†å“å</label>
            <input type="text" id="edit-name" value="${analyzedProduct.name}">
          </div>
          <div class="form-group">
            <label>å•†å“èª¬æ˜</label>
            <textarea id="edit-description" rows="4">${analyzedProduct.description}</textarea>
          </div>
          <div class="form-group">
            <label>è²©å£²ä¾¡æ ¼</label>
            <input type="number" id="edit-price" value="${analyzedProduct.price}">
          </div>
          <div class="form-group">
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="edit-category">
              <option value="å€‹äººå‘ã‘" ${analyzedProduct.category === 'å€‹äººå‘ã‘' ? 'selected' : ''}>å€‹äººå‘ã‘</option>
              <option value="ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ " ${analyzedProduct.category === 'ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ ' ? 'selected' : ''}>ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ </option>
              <option value="è»Šä¸¡ãƒ»ãƒã‚¤ã‚¯" ${analyzedProduct.category === 'è»Šä¸¡ãƒ»ãƒã‚¤ã‚¯' ? 'selected' : ''}>è»Šä¸¡ãƒ»ãƒã‚¤ã‚¯</option>
            </select>
          </div>
          <div class="form-group">
            <label>ã‚¿ã‚°</label>
            <input type="text" id="edit-tags" value="${(analyzedProduct.tags || []).join(', ')}">
            <small>ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š</small>
          </div>
          <div class="form-group">
            <label>å•†å“ç”»åƒ</label>
            <div class="preview-images">
              ${(analyzedProduct.image_urls || []).map(img => `<img src="${img.startsWith('http') ? img : '/images/' + img}" class="preview-image">`).join('')}
            </div>
          </div>
          <div style="background: #e3f2fd; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
            <strong>å…ƒã®ä»•å…¥ã‚Œä¾¡æ ¼:</strong> $${data.data.originalData.minPrice} (ç´„Â¥${Math.round(data.data.originalData.minPrice * 150)})<br>
            <strong>ãƒãƒ¼ã‚¸ãƒ³ç‡:</strong> ${marginRate}%<br>
            <strong>è²©å£²ä¾¡æ ¼:</strong> Â¥${analyzedProduct.price}
          </div>
        `;

        document.getElementById('preview-section').style.display = 'block';
        document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth' });

      } catch (error) {
        AdminNotification.error(error.message);
      } finally {
        document.getElementById('loading-overlay').style.display = 'none';
      }
    }

    async function registerProduct() {
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ç·¨é›†ã•ã‚ŒãŸå€¤ã‚’å–å¾—
      const productData = {
        name: document.getElementById('edit-name').value,
        description: document.getElementById('edit-description').value,
        price: parseFloat(document.getElementById('edit-price').value),
        category: document.getElementById('edit-category').value,
        alibaba_url: analyzedProduct.alibaba_url,
        alibaba_price: analyzedProduct.alibaba_price,
        stock_status: 'in_stock',
        image_urls: analyzedProduct.image_urls,
        specifications: analyzedProduct.specifications || {}
      };

      try {
        const response = await fetch('/api/admin/products', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify(productData)
        });

        const data = await response.json();

        if (data.success) {
          AdminNotification.success('å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
          cancelPreview();
          document.getElementById('alibaba-url').value = '';
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        AdminNotification.error('å•†å“ç™»éŒ²ã«å¤±æ•—: ' + error.message);
      }
    }

    function cancelPreview() {
      document.getElementById('preview-section').style.display = 'none';
      analyzedProduct = null;
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('admin_token');
      if (token) {
        adminToken = token;
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
      }
    });
  </script>

  <!-- Admin JavaScript API -->
  <script src="/js/admin.js"></script>
</body>
</html>
