<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†ç”»é¢ | ã‚¹ãƒãƒ¼ãƒˆãƒãƒªã‚¹</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .admin-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .admin-tabs { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #e0e0e0; }
    .admin-tab { padding: 1rem 2rem; cursor: pointer; border: none; background: none; font-size: 1rem; font-weight: 600; color: var(--text-light); }
    .admin-tab.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); margin-bottom: -2px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .ai-form { background: #f8f9fa; padding: 2rem; border-radius: 10px; margin-bottom: 2rem; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem; }
    .preview-card { background: white; padding: 2rem; border-radius: 10px; border: 2px solid #e0e0e0; }
    .preview-images { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .preview-image { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .loading-content { background: white; padding: 3rem; border-radius: 10px; text-align: center; }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="/" class="logo">ğŸ›¡ï¸ ã‚¹ãƒãƒ¼ãƒˆãƒãƒªã‚¹ ç®¡ç†ç”»é¢</a>
      <button onclick="logout()" class="btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </nav>
  </header>

  <div id="login-form" style="max-width: 400px; margin: 4rem auto;">
    <div class="card">
      <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="form-group">
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
      </div>
      <div class="form-group">
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      </div>
      <button onclick="login()" class="btn btn-primary" style="width: 100%;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
  </div>

  <div id="admin-panel" style="display: none;">
    <div class="admin-container">
      <h1>ç®¡ç†ç”»é¢</h1>

      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchTab('ai-register')">ğŸ¤– AIå•†å“ç™»éŒ²</button>
        <button class="admin-tab" onclick="switchTab('products')">ğŸ“¦ å•†å“ç®¡ç†</button>
        <button class="admin-tab" onclick="switchTab('orders')">ğŸ“‹ æ³¨æ–‡ç®¡ç†</button>
      </div>

      <!-- AIå•†å“ç™»éŒ²ã‚¿ãƒ– -->
      <div id="ai-register-tab" class="tab-content active">
        <div class="ai-form">
          <h2>ğŸ¤– AIå•†å“ç™»éŒ²</h2>
          <p style="color: var(--text-light); margin-bottom: 2rem;">Alibabaã®å•†å“URLã‚’å…¥åŠ›ã™ã‚‹ã¨ã€AIãŒè‡ªå‹•ã§å•†å“æƒ…å ±ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚</p>

          <div class="form-group">
            <label>Alibabaå•†å“URL *</label>
            <input type="url" id="alibaba-url" placeholder="https://www.alibaba.com/product-detail/..." 
                   value="https://www.alibaba.com/product-detail/10-Hours-Work-Anti-spy-Bug_1601658778634.html">
          </div>

          <div class="form-group">
            <label>ãƒãƒ¼ã‚¸ãƒ³ç‡ï¼ˆ%ï¼‰ *</label>
            <input type="number" id="margin-rate" value="100" min="0" max="500" placeholder="100">
            <small style="color: var(--text-light);">ä¾‹: 100% = ä»•å…¥ã‚Œä¾¡æ ¼ã®2å€ã§è²©å£²</small>
          </div>

          <button onclick="analyzeProduct()" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.125rem;">
            ğŸ” AIåˆ†æã‚’é–‹å§‹
          </button>
        </div>

        <div id="preview-section" style="display: none;">
          <div class="preview-card">
            <h2>ğŸ“ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <div id="preview-content"></div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
              <button onclick="registerProduct()" class="btn btn-primary" style="flex: 1; padding: 1rem;">âœ… ã“ã®å†…å®¹ã§ç™»éŒ²</button>
              <button onclick="cancelPreview()" class="btn" style="flex: 1; padding: 1rem;">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
        </div>
      </div>

      <!-- å•†å“ç®¡ç†ã‚¿ãƒ– -->
      <div id="products-tab" class="tab-content">
        <h2>å•†å“ç®¡ç†</h2>
        <p>é–‹ç™ºä¸­...</p>
      </div>

      <!-- æ³¨æ–‡ç®¡ç†ã‚¿ãƒ– -->
      <div id="orders-tab" class="tab-content">
        <h2>æ³¨æ–‡ç®¡ç†</h2>
        <p>é–‹ç™ºä¸­...</p>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <div class="spinner" style="width: 60px; height: 60px; margin: 0 auto 1.5rem;"></div>
      <h3>AIåˆ†æä¸­...</h3>
      <p style="color: var(--text-light);">å•†å“æƒ…å ±ã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™ï¼ˆ30ç§’ç¨‹åº¦ï¼‰</p>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    let adminToken = null;
    let analyzedProduct = null;

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        const response = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          adminToken = data.data.token;
          localStorage.setItem('admin_token', adminToken);
          document.getElementById('login-form').style.display = 'none';
          document.getElementById('admin-panel').style.display = 'block';
          Notification.success('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
        } else {
          Notification.error('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        Notification.error('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    function logout() {
      localStorage.removeItem('admin_token');
      location.reload();
    }

    function switchTab(tabName) {
      document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    async function analyzeProduct() {
      const alibabaUrl = document.getElementById('alibaba-url').value;
      const marginRate = parseInt(document.getElementById('margin-rate').value);

      if (!alibabaUrl) {
        Notification.error('Alibaba URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      document.getElementById('loading-overlay').style.display = 'flex';

      try {
        const response = await fetch('/api/admin/products/analyze-alibaba', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ alibabaUrl, marginRate })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        analyzedProduct = data.data.product;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        document.getElementById('preview-content').innerHTML = `
          <div class="form-group">
            <label>å•†å“å</label>
            <input type="text" id="edit-name" value="${analyzedProduct.name}">
          </div>
          <div class="form-group">
            <label>å•†å“èª¬æ˜</label>
            <textarea id="edit-description" rows="4">${analyzedProduct.description}</textarea>
          </div>
          <div class="form-group">
            <label>è²©å£²ä¾¡æ ¼</label>
            <input type="number" id="edit-price" value="${analyzedProduct.price}">
          </div>
          <div class="form-group">
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="edit-category">
              <option value="å€‹äººå‘ã‘" ${analyzedProduct.category === 'å€‹äººå‘ã‘' ? 'selected' : ''}>å€‹äººå‘ã‘</option>
              <option value="ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ " ${analyzedProduct.category === 'ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ ' ? 'selected' : ''}>ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ </option>
              <option value="è»Šä¸¡ãƒ»ãƒã‚¤ã‚¯" ${analyzedProduct.category === 'è»Šä¸¡ãƒ»ãƒã‚¤ã‚¯' ? 'selected' : ''}>è»Šä¸¡ãƒ»ãƒã‚¤ã‚¯</option>
            </select>
          </div>
          <div class="form-group">
            <label>ã‚¿ã‚°</label>
            <input type="text" id="edit-tags" value="${(analyzedProduct.tags || []).join(', ')}">
            <small>ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š</small>
          </div>
          <div class="form-group">
            <label>å•†å“ç”»åƒ</label>
            <div class="preview-images">
              ${(analyzedProduct.image_urls || []).map(img => `<img src="${img.startsWith('http') ? img : '/images/' + img}" class="preview-image">`).join('')}
            </div>
          </div>
          <div style="background: #e3f2fd; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
            <strong>å…ƒã®ä»•å…¥ã‚Œä¾¡æ ¼:</strong> $${data.data.originalData.minPrice} (ç´„Â¥${Math.round(data.data.originalData.minPrice * 150)})<br>
            <strong>ãƒãƒ¼ã‚¸ãƒ³ç‡:</strong> ${marginRate}%<br>
            <strong>è²©å£²ä¾¡æ ¼:</strong> Â¥${analyzedProduct.price}
          </div>
        `;

        document.getElementById('preview-section').style.display = 'block';
        document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth' });

      } catch (error) {
        Notification.error(error.message);
      } finally {
        document.getElementById('loading-overlay').style.display = 'none';
      }
    }

    async function registerProduct() {
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ç·¨é›†ã•ã‚ŒãŸå€¤ã‚’å–å¾—
      const productData = {
        name: document.getElementById('edit-name').value,
        description: document.getElementById('edit-description').value,
        price: parseFloat(document.getElementById('edit-price').value),
        category: document.getElementById('edit-category').value,
        alibaba_url: analyzedProduct.alibaba_url,
        alibaba_price: analyzedProduct.alibaba_price,
        stock_status: 'in_stock',
        image_urls: analyzedProduct.image_urls,
        specifications: analyzedProduct.specifications || {}
      };

      try {
        const response = await fetch('/api/admin/products', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify(productData)
        });

        const data = await response.json();

        if (data.success) {
          Notification.success('å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
          cancelPreview();
          document.getElementById('alibaba-url').value = '';
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        Notification.error('å•†å“ç™»éŒ²ã«å¤±æ•—: ' + error.message);
      }
    }

    function cancelPreview() {
      document.getElementById('preview-section').style.display = 'none';
      analyzedProduct = null;
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('admin_token');
      if (token) {
        adminToken = token;
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
      }
    });
  </script>
</body>
</html>
